$(document).ready(function(){$("#variant_autocomplete_template").length>0&&(window.variantTemplate=Handlebars.compile($("#variant_autocomplete_template").text()),window.variantStockTemplate=Handlebars.compile($("#variant_autocomplete_stock_template").text()),$("#add_variant_id").change(function(){var e=$(this).val(),t=_.find(window.variants,function(t){return t.id==e});$("#stock_details").html(variantStockTemplate({variant:t})),$("#stock_details").show(),$("button.add_variant").click(addVariantFromStockLocation),$(".with-tip").powerTip({smartPlacement:!0,fadeInTime:50,fadeOutTime:50,intentPollInterval:300})}),$("a.edit-item").click(toggleItemEdit),$("a.cancel-item").click(toggleItemEdit),$("a.split-item").click(startItemSplit),$("a.save-item").click(function(){var e=$(this),t=e.data("shipment-number"),i=e.data("variant-id"),n=parseInt(e.parents("tr").find("input.line_item_quantity").val());return toggleItemEdit(),adjustItems(t,i,n),!1}),$("a.delete-item").click(function(){var e=$(this),t=e.data("shipment-number"),i=e.data("variant-id");toggleItemEdit(),adjustItems(t,i,0)}))}),adjustItems=function(e,t,i){var n=_.findWhere(shipments,{number:e+""}),s=_.where(n.inventory_units,{variant_id:t}),a="/api/orders/"+order_number+"/shipments/"+e,r=0;s.length<i?(a+="/add",r=i-s.length):s.length>i&&(a+="/remove",r=s.length-i),a+=".json",0!=r&&$.ajax({type:"PUT",url:Spree.url(a),data:{variant_id:t,quantity:r}}).done(function(){window.location.reload()})},toggleTrackingEdit=function(){var e=$(this);e.parents("tbody").find("tr.edit-tracking").toggle(),e.parents("tbody").find("tr.show-tracking").toggle()},toggleMethodEdit=function(){var e=$(this);e.parents("tbody").find("tr.edit-method").toggle(),e.parents("tbody").find("tr.show-method").toggle()},toggleItemEdit=function(){var e=$(this);return e.parent().find("a.edit-item").toggle(),e.parent().find("a.cancel-item").toggle(),e.parent().find("a.split-item").toggle(),e.parent().find("a.save-item").toggle(),e.parent().find("a.delete-item").toggle(),e.parents("tr").find("td.item-qty-show").toggle(),e.parents("tr").find("td.item-qty-edit").toggle(),!1},startItemSplit=function(e){e.preventDefault();var t=$(this);t.parent().find("a.edit-item").toggle(),t.parent().find("a.split-item").toggle(),t.parent().find("a.delete-item").toggle();var i=t.data("variant-id"),n={};$.ajax({type:"GET",async:!1,url:Spree.url("/api/variants.json"),data:{q:{id_eq:i}}}).success(function(e){n=e.variants[0]}).error(function(e){console.log(e)});var s=t.closest("tr").data("item-quantity"),a=Handlebars.compile($("#variant_split_template").text());t.closest("tr").after(a({variant:n,shipments:shipments,max_quantity:s})),$("a.cancel-split").click(cancelItemSplit),$("a.save-split").click(completeItemSplit),$(".with-tip").powerTip({smartPlacement:!0,fadeInTime:50,fadeOutTime:50,intentPollInterval:300}),$("#item_stock_location").select2({width:"resolve",placeholder:"Choose Location"})},completeItemSplit=function(e){e.preventDefault();var t=$(this),i=t.closest("tbody").data("order-number"),n=t.closest("tr"),s=n.data("variant-id"),a=n.find("#item_quantity").val(),r=n.find("#item_stock_location").val(),o=t.closest("tbody").data("shipment-number"),l=n.find($("#item_stock_location").select2("data").element),c=l.data("shipment-number"),h=l.data("new-shipment");"new_shipment"!=r&&($.ajax({type:"PUT",async:!1,url:Spree.url("/api/orders/"+i+"/shipments/"+o+"/remove.json"),data:{variant_id:s,quantity:a}}).done(function(){window.location.reload()}),void 0!=h?$.ajax({type:"POST",async:!1,url:Spree.url("/api/orders/"+i+"/shipments.json"),data:{variant_id:s,quantity:a,stock_location_id:r}}):$.ajax({type:"PUT",async:!1,url:Spree.url("/api/orders/"+i+"/shipments/"+c+"/add.json"),data:{variant_id:s,quantity:a}}))},cancelItemSplit=function(e){e.preventDefault();var t=$(this),i=t.closest("tr").prev();t.closest("tr").remove(),i.find("a.edit-item").toggle(),i.find("a.split-item").toggle(),i.find("a.delete-item").toggle()},addVariantFromStockLocation=function(){$("#stock_details").hide();var e=$("input.variant_autocomplete").val(),t=$(this).data("stock-location-id"),i=$("input.quantity[data-stock-location-id='"+t+"']").val(),n=_.find(shipments,function(e){return e.stock_location_id==t&&("ready"==e.state||"pending"==e.state)});return void 0==n?$.ajax({type:"POST",url:Spree.url("/api/orders/"+order_number+"/shipments.json"),data:{variant_id:e,quantity:i,stock_location_id:t}}).done(function(){window.location.reload()}).error(function(e){console.log(e)}):adjustItems(n.number,e,i),1},formatVariantResult=function(e){return void 0!=e.images[0]&&void 0!=e.images[0].urls&&(e.image=e.images[0].urls.mini),variantTemplate({variant:e})},$.fn.variantAutocomplete=function(){this.parent().children(".options_placeholder").attr("id",this.parent().data("index")),this.select2({placeholder:"Select a variant",minimumInputLength:3,ajax:{url:Spree.url(Spree.routes.variants_search),datatype:"json",data:function(e){return{q:{product_name_or_sku_cont:e}}},results:function(e){return window.variants=e.variants,{results:e.variants}}},formatResult:formatVariantResult,formatSelection:function(e){return $(this.element).parent().children(".options_placeholder").html(e.options_text),e.name}})};